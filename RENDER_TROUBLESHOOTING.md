# 🚨 Render Deployment Troubleshooting Guide

## Your Current Issue: "Bad Gateway" Error

**Error**: `This service is currently unavailable`  
**Meaning**: Your Render backend failed to deploy or isn't running.

---

## ✅ **I Just Fixed Two Critical Issues**

### Fix #1: Gunicorn PORT Binding
**Changed**:
```bash
# Before (won't work on Render):
gunicorn config.wsgi:application

# After (correct):
gunicorn config.wsgi:application --bind 0.0.0.0:$PORT
```

**Why**: Render assigns a dynamic PORT, gunicorn must bind to it.

### Fix #2: Better Build Script Logging
Added detailed logging to help debug if build fails.

**Code pushed to GitHub** ✅  
**Render will auto-deploy now** 🚀

---

## 🎯 **What You Need to Do NOW**

### **Step 1: Verify Neon Database Connection**

1. Go to: https://neon.tech
2. Open your project: **ahmad-poultry-services**
3. Copy the **connection string** (should look like):
   ```
   postgresql://username:password@ep-xyz-123.us-east-2.aws.neon.tech/dbname?sslmode=require
   ```

### **Step 2: Update Render Environment Variables**

1. Go to: https://dashboard.render.com
2. Click your service: **ahmad-poultry-backend**
3. Click **"Environment"** tab
4. **Verify/Update these variables:**

```env
PYTHON_VERSION = 3.11.0

DJANGO_SECRET_KEY = (should be auto-generated by Render)

DEBUG = False

ALLOWED_HOSTS = ahmad-poultery-backend.onrender.com,ahmad-poultry-services.netlify.app

DATABASE_URL = postgresql://your-neon-connection-string-here?sslmode=require

CORS_ALLOWED_ORIGINS = https://ahmad-poultry-services.netlify.app,http://localhost:5173

TIME_ZONE = Asia/Karachi

JWT_ACCESS_TOKEN_LIFETIME = 60

JWT_REFRESH_TOKEN_LIFETIME = 1440
```

**⚠️ CRITICAL**: The `DATABASE_URL` MUST be your actual Neon connection string!

5. Click **"Save Changes"** if you made any updates
6. Render will automatically redeploy

---

## 📊 **Step 3: Monitor the Deployment**

### **Watch the Build Logs:**

1. Stay in Render Dashboard
2. Click **"Events"** or **"Logs"** tab
3. Watch for these success messages:

```bash
🚀 Starting Ahmad Poultry Backend Build
📦 Step 1: Installing Python dependencies...
✅ Dependencies installed successfully

🗄️  Step 2: Running database migrations...
✅ Migrations completed successfully

👤 Step 3: Creating superuser...
✅ Superuser "admin" created successfully

🌱 Step 4: Loading seed data...
Created customer: Ali Traders
Created customer: Bismillah Store
...
✅ Seed data loaded successfully

📁 Step 5: Collecting static files...
✅ Static files collected successfully

🎉 Build completed successfully!

==> Starting service with 'gunicorn config.wsgi:application --bind 0.0.0.0:$PORT'
==> Your service is live 🎉
```

### **Deployment Timeline:**
- **Build**: 3-5 minutes
- **Deploy**: 1-2 minutes
- **Total**: ~5-7 minutes

---

## 🔴 **Common Errors & Solutions**

### **Error 1: "psycopg2.OperationalError: could not connect to server"**

**Meaning**: Database connection failed

**Solutions**:
- ✅ Verify `DATABASE_URL` is correct Neon connection string
- ✅ Must end with `?sslmode=require`
- ✅ Check Neon database is active (not suspended)
- ✅ Verify Neon project region matches Render region

---

### **Error 2: "ModuleNotFoundError: No module named 'X'"**

**Meaning**: Missing Python package

**Solutions**:
- ✅ Check `backend/requirements.txt` includes all packages
- ✅ Verify `pip install -r requirements.txt` runs in build logs
- ✅ Try adding `pip install --upgrade pip` before install

---

### **Error 3: "django.core.exceptions.ImproperlyConfigured"**

**Meaning**: Django settings issue

**Solutions**:
- ✅ Check all required environment variables are set
- ✅ Verify `SECRET_KEY` is generated
- ✅ Check `ALLOWED_HOSTS` includes your Render domain

---

### **Error 4: "Address already in use" or "Bind failed"**

**Meaning**: PORT binding issue

**Solutions**:
- ✅ Make sure start command is: `gunicorn config.wsgi:application --bind 0.0.0.0:$PORT`
- ✅ Don't hardcode port numbers
- ✅ Use `$PORT` environment variable

---

### **Error 5: "Build failed: build.sh: Permission denied"**

**Meaning**: Script not executable

**Solutions**:
- ✅ Build command must include: `chmod +x build.sh && ./build.sh`
- ✅ Already fixed in latest commit ✅

---

### **Error 6: "Bad Gateway" after successful build**

**Meaning**: Service started but crashed immediately

**Solutions**:
- ✅ Check **Runtime logs** (not build logs)
- ✅ Look for Python errors in service logs
- ✅ Verify gunicorn is binding to `0.0.0.0:$PORT`
- ✅ Check database connection is working

---

## 🧪 **Step 4: Test After Deployment**

### **When logs show "Your service is live":**

1. **Wait 30 seconds** for service to fully start

2. **Test API Root**:
   ```
   https://ahmad-poultery-backend.onrender.com/
   ```
   **Expected**: JSON response with "Welcome to Ahmad Poultry Services API"

3. **Test API Docs**:
   ```
   https://ahmad-poultery-backend.onrender.com/api/docs/
   ```
   **Expected**: Swagger UI interface

4. **Test Admin Panel**:
   ```
   https://ahmad-poultery-backend.onrender.com/admin/
   ```
   **Expected**: Django admin login page

5. **Test Login API** (using Swagger UI):
   - Click on `/api/auth/login/` endpoint
   - Click "Try it out"
   - Enter:
     ```json
     {
       "username": "admin",
       "password": "Admin@123"
     }
     ```
   - Click "Execute"
   - **Expected**: JSON with `access` and `refresh` tokens

---

## ✅ **Success Indicators**

You'll know it's working when:

1. ✅ Build logs show "Build completed successfully!"
2. ✅ Runtime logs show "Booting worker" and "Starting gunicorn"
3. ✅ Service status shows green "Live"
4. ✅ API root URL returns JSON (not error page)
5. ✅ No errors in runtime logs
6. ✅ Login API returns JWT tokens

---

## 🔄 **If Deployment Still Fails**

### **Option 1: Manual Trigger**

In Render Dashboard:
1. Click **"Manual Deploy"**
2. Select branch: **main**
3. Click **"Deploy"**

### **Option 2: Check Service Settings**

Verify these are correct:
```
Name: ahmad-poultry-backend
Runtime: Python 3
Region: Same as Neon (e.g., Oregon, US East)
Branch: main
Root Directory: backend
Build Command: chmod +x build.sh && ./build.sh
Start Command: gunicorn config.wsgi:application --bind 0.0.0.0:$PORT
```

### **Option 3: Check Render Service Logs**

1. Go to **"Logs"** tab
2. Switch to **"Runtime Logs"** (not Build Logs)
3. Look for Python errors or crashes
4. Share the error message if you need help

---

## 📝 **Copy-Paste Environment Variables**

For quick setup, copy all these to Render Environment:

```
PYTHON_VERSION=3.11.0
DEBUG=False
ALLOWED_HOSTS=ahmad-poultery-backend.onrender.com,ahmad-poultry-services.netlify.app
DATABASE_URL=postgresql://your-neon-string?sslmode=require
CORS_ALLOWED_ORIGINS=https://ahmad-poultry-services.netlify.app,http://localhost:5173
TIME_ZONE=Asia/Karachi
JWT_ACCESS_TOKEN_LIFETIME=60
JWT_REFRESH_TOKEN_LIFETIME=1440
```

**⚠️ Replace `DATABASE_URL` with your actual Neon connection string!**

---

## 🎯 **Quick Checklist**

Before asking for help, verify:

- [ ] Neon database is active and accessible
- [ ] DATABASE_URL environment variable is set correctly
- [ ] DATABASE_URL ends with `?sslmode=require`
- [ ] All 9 environment variables are set on Render
- [ ] Latest code is pushed to GitHub main branch
- [ ] Root Directory is set to `backend` on Render
- [ ] Start command includes `--bind 0.0.0.0:$PORT`
- [ ] Build logs show "Build completed successfully!"
- [ ] Service shows "Live" status (green)
- [ ] Waited at least 30 seconds after "Live" status

---

## 🆘 **Still Need Help?**

**Share these with me:**

1. **Render Build Logs** (full output from latest deploy)
2. **Render Runtime Logs** (errors after service starts)
3. **Your Neon connection string** (first 50 characters only)
4. **Environment variables** (names only, not values)
5. **Service settings** (screenshot or text)

---

## 🚀 **Next Steps After Success**

Once backend is live:

1. ✅ Test all API endpoints in Swagger UI
2. ✅ Verify 25 customers were created
3. ✅ Verify 30 days of transaction data exists
4. ✅ Update Netlify `VITE_API_BASE_URL` to your Render URL
5. ✅ Redeploy Netlify
6. ✅ Test login from frontend
7. ✅ Check dashboard shows data

---

**Your deployment should now work! Check Render logs and tell me what you see.** 🎉

